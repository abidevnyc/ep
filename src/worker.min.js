import{connect}from"cloudflare:sockets";let sha224Password="08f32643dbdacf81d0d511f1ee24b06de759e90f8edf742bbdc57d87",proxyIP="";if(!isValidSHA224(sha224Password))throw new Error("sha224Password is not valid");let worker_default={async fetch(e,r,a){try{proxyIP=r.PROXYIP||proxyIP,sha224Password=r.SHA224PASS||sha224Password;var t,o=e.headers.get("Upgrade");return o&&"websocket"===o?await trojanOverWSHandler(e):"/link"!==new URL(e.url).pathname?new Response("404 Not found",{status:404}):(t=e.headers.get("Host"),new Response(`trojan://ca110us@${t}:443/?type=ws&host=${t}&security=tls`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}}))}catch(e){return new Response(e.toString())}}};async function trojanOverWSHandler(e){let r=new WebSocketPair,[a,n]=Object.values(r),c=(n.accept(),""),l="",i=(e,r)=>{console.log(`[${c}:${l}] `+e,r||"")},d=(r=e.headers.get("sec-websocket-protocol")||"",e=makeReadableWebSocketStream(n,r,i),{value:null});return e.pipeTo(new WritableStream({async write(e,r){if(d.value)await(a=d.value.writable.getWriter()).write(e),a.releaseLock();else{var{hasError:a,message:e,portRemote:t=443,addressRemote:o="",rawClientData:s}=await parseTrojanHeader(e);if(c=o,l=`${t}--${Math.random()} tcp`,a)throw new Error(e);handleTCPOutBound(d,o,t,s,n,i)}},close(){i("readableWebSocketStream is closed")},abort(e){i("readableWebSocketStream is aborted",JSON.stringify(e))}})).catch(e=>{i("readableWebSocketStream pipeTo error",e)}),new Response(null,{status:101,webSocket:a})}async function parseTrojanHeader(e){if(e.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(e.slice(56,57))[0]||10!==new Uint8Array(e.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(e.slice(0,56))!==sha224Password)return{hasError:!0,message:"invalid password"};var r=e.slice(58);if(r.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};if(1!==(e=new DataView(r)).getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};let a,t=e.getUint8(1),o=0,s=2,n="";switch(t){case 1:o=4,n=new Uint8Array(r.slice(s,s+o)).join(".");break;case 3:o=new Uint8Array(r.slice(s,s+1))[0],s+=1,n=(new TextDecoder).decode(r.slice(s,s+o));break;case 4:o=16;var c=new DataView(r.slice(s,s+o)),l=[];for(let e=0;e<8;e++)l.push(c.getUint16(2*e).toString(16));n=l.join(":");break;default:return{hasError:!0,message:"invalid addressType is "+t}}return n?(e=s+o,a=r.slice(e,e+2),a=new DataView(a).getUint16(0),{hasError:!1,addressRemote:n,portRemote:a,rawClientData:r.slice(e+4)}):{hasError:!0,message:"address is empty, addressType is "+t}}async function handleTCPOutBound(t,r,a,o,s,n){async function c(e,r){var a=connect({hostname:e,port:r});return t.value=a,n(`connected to ${e}:`+r),await(e=a.writable.getWriter()).write(o),e.releaseLock(),a}remoteSocketToWS(await c(r,a),s,async function(){var e=await c(proxyIP||r,a);e.closed.catch(e=>{console.log("retry tcpSocket closed error",e)}).finally(()=>{safeCloseWebSocket(s)}),remoteSocketToWS(e,s,null,n)},n)}function makeReadableWebSocketStream(t,o,s){let n=!1;return new ReadableStream({start(r){t.addEventListener("message",e=>{n||(e=e.data,r.enqueue(e))}),t.addEventListener("close",()=>{safeCloseWebSocket(t),n||r.close()}),t.addEventListener("error",e=>{s("webSocketServer error"),r.error(e)});var{earlyData:e,error:a}=base64ToArrayBuffer(o);a?r.error(a):e&&r.enqueue(e)},pull(e){},cancel(e){n||(s("readableStream was canceled, due to "+e),n=!0,safeCloseWebSocket(t))}})}async function remoteSocketToWS(e,a,r,t){let o=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,r){o=!0,a.readyState!==WS_READY_STATE_OPEN&&r.error("webSocket connection is not open"),a.send(e)},close(){t("remoteSocket.readable is closed, hasIncomingData: "+o)},abort(e){console.error("remoteSocket.readable abort",e)}})).catch(e=>{console.error("remoteSocketToWS error:",e.stack||e),safeCloseWebSocket(a)}),!1===o&&r&&(t("retry"),r())}function isValidSHA224(e){return/^[0-9a-f]{56}$/i.test(e)}function base64ToArrayBuffer(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");var r=atob(e);return{earlyData:Uint8Array.from(r,e=>e.charCodeAt(0)).buffer,error:null}}catch(e){return{error:e}}}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}export{worker_default as default};
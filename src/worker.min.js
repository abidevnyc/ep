import{connect}from"cloudflare:sockets";let userID="90cd4a77-141a-43c9-991b-08263cfe9c10",proxyIP="",sub="",subconverter="SUBAPI.fxxk.dedyn.io",subconfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini",subProtocol="https",socks5Address="";if(!isValidUUID(userID))throw new Error("uuid is not valid");let parsedSocks5Address={},enableSocks=!1,fakeUserID,fakeHostName,noTLS="false",expire=4102329600,proxyIPs,socks5s,go2Socks5s=["*ttvnw.net"],addresses=[],addressesapi=[],addressesnotls=[],addressesnotlsapi=[],addressescsv=[],DLS=8,FileName="edgetunnel",BotToken="",ChatID="",proxyhosts=[],proxyhostsURL="https://raw.githubusercontent.com/cmliu/CFcdnVmess2sub/main/proxyhosts",RproxyIP="false";export default{async fetch(r,a,e){try{var o=r.headers.get("User-Agent")||"null",n=o.toLowerCase(),s=(userID=(a.UUID||userID).toLowerCase(),new Date),t=(s.setHours(0,0,0,0),Math.ceil(s.getTime()/1e3)),i=await MD5MD5(""+userID+t);if(fakeUserID=i.slice(0,8)+"-"+i.slice(8,12)+"-"+i.slice(12,16)+"-"+i.slice(16,20)+"-"+i.slice(20),fakeHostName=i.slice(6,9)+"."+i.slice(13,19),proxyIP=a.PROXYIP||proxyIP,proxyIPs=await ADD(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=a.SOCKS5||socks5Address,socks5s=await ADD(socks5Address),socks5Address=(socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)]).split("//")[1]||socks5Address,sub=a.SUB||sub,(subconverter=a.SUBAPI||subconverter).includes("http://")?(subconverter=subconverter.split("//")[1],subProtocol="http"):subconverter=subconverter.split("//")[1]||subconverter,subconfig=a.SUBCONFIG||subconfig,socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=a.RPROXYIP||"false",enableSocks=!0}catch(e){var c=e;console.log(c.toString()),RproxyIP=a.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=a.RPROXYIP||!proxyIP?"true":"false";a.ADD&&(addresses=await ADD(a.ADD)),a.ADDAPI&&(addressesapi=await ADD(a.ADDAPI)),a.ADDNOTLS&&(addressesnotls=await ADD(a.ADDNOTLS)),a.ADDNOTLSAPI&&(addressesnotlsapi=await ADD(a.ADDNOTLSAPI)),a.ADDCSV&&(addressescsv=await ADD(a.ADDCSV)),DLS=a.DLS||DLS,BotToken=a.TGTOKEN||BotToken,ChatID=a.TGID||ChatID,a.GO2SOCKS5&&(go2Socks5s=await ADD(a.GO2SOCKS5));var l=r.headers.get("Upgrade"),d=new URL(r.url);if(d.searchParams.has("sub")&&""!==d.searchParams.get("sub")&&(sub=d.searchParams.get("sub")),FileName=a.SUBNAME||FileName,d.searchParams.has("notls")&&(noTLS="true"),l&&"websocket"===l){if(proxyIP=d.searchParams.get("proxyip")||proxyIP,new RegExp("/proxyip=","i").test(d.pathname)?proxyIP=d.pathname.toLowerCase().split("/proxyip=")[1]:new RegExp("/proxyip.","i").test(d.pathname)&&(proxyIP="proxyip."+d.pathname.toLowerCase().split("/proxyip.")[1]),socks5Address=d.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(d.pathname))socks5Address=d.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(d.pathname)||new RegExp("/socks5://","i").test(d.pathname))&&(socks5Address=d.pathname.split("://")[1].split("#")[0]).includes("@")){let e=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(e)&&!e.includes(":")&&(e=atob(e)),socks5Address=e+"@"+socks5Address.split("@")[1]}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(e){var u=e;console.log(u.toString()),enableSocks=!1}else enableSocks=!1;return await vlessOverWSHandler(r)}switch(d.pathname.toLowerCase()){case"/":var p=a.URL302?"URL302":a.URL?"URL":null;if(p){var h=await ADD(a[p]);let e=h[Math.floor(Math.random()*h.length)];return"URL302"===p?Response.redirect(e,302):fetch(new Request(e,r))}return new Response(JSON.stringify(r.cf,null,4),{status:200});case"/"+fakeUserID:var f=await getVLESSConfig(userID,r.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,d);return new Response(""+f,{status:200});case"/"+userID:{await sendMessage("#获取订阅 "+FileName,r.headers.get("CF-Connecting-IP"),`UA: ${o}</tg-spoiler>
域名: ${d.hostname}
<tg-spoiler>入口: ${d.pathname+d.search}</tg-spoiler>`),sub&&""!=sub||addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length!=0||(subconfig=r.headers.get("Host").includes(".workers.dev")?(sub="noTLS.fxxk.dedyn.io",a.SUBCONFIG||"https://raw.githubusercontent.com/cmliu/ACL4SSR/main/Clash/config/ACL4SSR_Online.ini"):(sub="VLESS.fxxk.dedyn.io",a.SUBCONFIG||"https://raw.githubusercontent.com/cmliu/ACL4SSR/main/Clash/config/ACL4SSR_Online_Full_MultiMode.ini"));var S,g,w,m,y,b,A=await getVLESSConfig(userID,r.headers.get("Host"),sub,o,RproxyIP,d),k=Date.now(),I=new Date(k),x=(I.setHours(0,0,0,0),Math.floor((k-I.getTime())/864e5*24*1099511627776/2));let e=x,s=x,t=26388279066624;return a.CFEMAIL&&a.CFKEY&&(S=a.CFEMAIL,w=a.CFID||0,m=await getAccountId(S,g=a.CFKEY))&&((y=new Date).setUTCHours(0,0,0,0),b=await getSum(m,w,S,g,y.toISOString(),(new Date).toISOString()),e=b[0],s=b[1],t=102400),n&&n.includes("mozilla")?new Response(""+A,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${e}; download=${s}; total=${t}; expire=`+expire}}):new Response(""+A,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''`+encodeURIComponent(FileName),"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${e}; download=${s}; total=${t}; expire=`+expire}})}default:return new Response("Not found",{status:404})}}catch(e){return new Response(e.toString())}}};async function vlessOverWSHandler(e){var s=new WebSocketPair;let[t,d]=Object.values(s),u=(d.accept(),""),p="",h=(e,s)=>{console.log(`[${u}:${p}] `+e,s||"")};s=e.headers.get("sec-websocket-protocol")||"",e=makeReadableWebSocketStream(d,s,h);let f={value:null},S=!1;return e.pipeTo(new WritableStream({async write(e,s){if(S)return handleDNSQuery(e,d,null,h);if(f.value)await(t=f.value.writable.getWriter()).write(e),t.releaseLock();else{var{hasError:t,message:r,addressType:a,portRemote:o=443,addressRemote:n="",rawDataIndex:i,vlessVersion:c=new Uint8Array([0,0]),isUDP:l}=processVlessHeader(e,userID);if(u=n,p=`${o}--${Math.random()} ${l?"udp ":"tcp "} `,t)throw new Error(r);if(l){if(53!==o)throw new Error("UDP 代理仅对 DNS（53 端口）启用");S=!0}t=new Uint8Array([c[0],0]),r=e.slice(i);if(S)return handleDNSQuery(r,d,t,h);h(`处理 TCP 出站连接 ${n}:`+o),handleTCPOutBound(f,a,n,o,r,d,t,h)}},close(){h("readableWebSocketStream 已关闭")},abort(e){h("readableWebSocketStream 已中止",JSON.stringify(e))}})).catch(e=>{h("readableWebSocketStream 管道错误",e)}),new Response(null,{status:101,webSocket:t})}async function handleTCPOutBound(r,a,e,s,o,t,n,i){async function c(e,s,t=!1){i(`connected to ${e}:`+s);t=t?await socks5Connect(a,e,s,i):connect({hostname:e,port:s}),e=(r.value=t).writable.getWriter();return await e.write(o),e.releaseLock(),t}let l=!1;var d;0<go2Socks5s.length&&enableSocks&&(l=(d=e,await(!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some(e=>{e=e.replace(/\*/g,".*");return new RegExp(`^${e}$`,"i").test(d)}))));let u=await c(e,s,l);remoteSocketToWS(u,t,n,async function(){(u=enableSocks?await c(e,s,!0):await c((proxyIP=proxyIP&&""!=proxyIP?proxyIP:atob("cHJveHlpcC5meHhrLmRlZHluLmlv"))||e,s)).closed.catch(e=>{console.log("retry tcpSocket closed error",e)}).finally(()=>{safeCloseWebSocket(t)}),remoteSocketToWS(u,t,n,null,i)},i)}function makeReadableWebSocketStream(r,a,o){let n=!1;return new ReadableStream({start(s){r.addEventListener("message",e=>{n||(e=e.data,s.enqueue(e))}),r.addEventListener("close",()=>{safeCloseWebSocket(r),n||s.close()}),r.addEventListener("error",e=>{o("WebSocket 服务器发生错误"),s.error(e)});var{earlyData:e,error:t}=base64ToArrayBuffer(a);t?s.error(t):e&&s.enqueue(e)},pull(e){},cancel(e){n||(o("可读流被取消，原因是 "+e),n=!0,safeCloseWebSocket(r))}})}function processVlessHeader(e,s){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};var t=new Uint8Array(e.slice(0,1));let r=!1,a=!1;if(!(r=stringify(new Uint8Array(e.slice(1,17)))===s?!0:r))return{hasError:!0,message:"invalid user "+new Uint8Array(e.slice(1,17))};var s=new Uint8Array(e.slice(17,18))[0],o=new Uint8Array(e.slice(18+s,18+s+1))[0];if(1!==o){if(2!==o)return{hasError:!0,message:`command ${o} is not support, command 01-tcp,02-udp,03-mux`};a=!0}var o=18+s+1,s=e.slice(o,o+2),s=new DataView(s).getUint16(0),o=o+2,n=new Uint8Array(e.slice(o,o+1))[0];let i=0,c=o+1,l="";switch(n){case 1:i=4,l=new Uint8Array(e.slice(c,c+i)).join(".");break;case 2:i=new Uint8Array(e.slice(c,c+1))[0],c+=1,l=(new TextDecoder).decode(e.slice(c,c+i));break;case 3:i=16;var d=new DataView(e.slice(c,c+i)),u=[];for(let e=0;e<8;e++)u.push(d.getUint16(2*e).toString(16));l=u.join(":");break;default:return{hasError:!0,message:"invild addressType is "+n}}return l?{hasError:!1,addressRemote:l,addressType:n,portRemote:s,rawDataIndex:c+i,vlessVersion:t,isUDP:a}:{hasError:!0,message:"addressValue is empty, addressType is "+n}}async function remoteSocketToWS(e,t,s,r,a){let o=s,n=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,s){n=!0,t.readyState!==WS_READY_STATE_OPEN&&s.error("webSocket.readyState is not open, maybe close"),o?(t.send(await new Blob([o,e]).arrayBuffer()),o=null):t.send(e)},close(){a("remoteConnection!.readable is close with hasIncomingData is "+n)},abort(e){console.error("remoteConnection!.readable abort",e)}})).catch(e=>{console.error("remoteSocketToWS has exception ",e.stack||e),safeCloseWebSocket(t)}),!1===n&&r&&(a("retry"),r())}function base64ToArrayBuffer(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");var s=atob(e);return{earlyData:Uint8Array.from(s,e=>e.charCodeAt(0)).buffer,error:null}}catch(e){return{error:e}}}function isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}let byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,s=0){return(byteToHex[e[s+0]]+byteToHex[e[s+1]]+byteToHex[e[s+2]]+byteToHex[e[s+3]]+"-"+byteToHex[e[s+4]]+byteToHex[e[s+5]]+"-"+byteToHex[e[s+6]]+byteToHex[e[s+7]]+"-"+byteToHex[e[s+8]]+byteToHex[e[s+9]]+"-"+byteToHex[e[s+10]]+byteToHex[e[s+11]]+byteToHex[e[s+12]]+byteToHex[e[s+13]]+byteToHex[e[s+14]]+byteToHex[e[s+15]]).toLowerCase()}function stringify(e,s=0){e=unsafeStringify(e,s);if(isValidUUID(e))return e;throw TypeError("生成的 UUID 不符合规范 "+e)}async function handleDNSQuery(e,r,a,o){try{let s="8.8.4.4";let t=a;var n=connect({hostname:s,port:53}),i=(o(`连接到 ${s}:53`),n.writable.getWriter());await i.write(e),i.releaseLock(),await n.readable.pipeTo(new WritableStream({async write(e){r.readyState===WS_READY_STATE_OPEN&&(t?(r.send(await new Blob([t,e]).arrayBuffer()),t=null):r.send(e))},close(){o(`DNS 服务器(${s}) TCP 连接已关闭`)},abort(e){console.error(`DNS 服务器(${s}) TCP 连接异常中断`,e)}}))}catch(e){console.error("handleDNSQuery 函数发生异常，错误信息: "+e.message)}}async function socks5Connect(s,t,r,a){var{username:o,password:n,hostname:i,port:c}=parsedSocks5Address,i=connect({hostname:i,port:c}),c=new Uint8Array([5,2,0,2]),l=i.writable.getWriter(),c=(await l.write(c),a("已发送 SOCKS5 问候消息"),i.readable.getReader()),d=new TextEncoder;let u=(await c.read()).value;if(5!==u[0])a(`SOCKS5 服务器版本错误: 收到 ${u[0]}，期望是 5`);else if(255===u[1])a("服务器不接受任何认证方法");else{if(2===u[1]){if(a("SOCKS5 服务器需要认证"),!o||!n)return void a("请提供用户名和密码");o=new Uint8Array([1,o.length,...d.encode(o),n.length,...d.encode(n)]);if(await l.write(o),1!==(u=(await c.read()).value)[0]||0!==u[1])return void a("SOCKS5 服务器认证失败")}let e;switch(s){case 1:e=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:e=new Uint8Array([3,t.length,...d.encode(t)]);break;case 3:e=new Uint8Array([4,...t.split(":").flatMap(e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)])]);break;default:return void a("无效的地址类型: "+s)}n=new Uint8Array([5,1,0,...e,r>>8,255&r]);if(await l.write(n),a("已发送 SOCKS5 请求"),0===(u=(await c.read()).value)[1])return a("SOCKS5 连接已建立"),l.releaseLock(),c.releaseLock(),i;a("SOCKS5 连接建立失败")}}function socks5AddressParser(e){var[e,s]=e.split("@").reverse();let t,r,a,o;if(s){s=s.split(":");if(2!==s.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[t,r]=s}s=e.split(":");if(o=Number(s.pop()),isNaN(o))throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");if((a=s.join(":")).includes(":")&&!/^\[.*\]$/.test(a))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:t,password:r,hostname:a,port:o}}function revertFakeInfo(e,s,t,r){return e=(e=r?atob(e):e).replace(new RegExp(fakeUserID,"g"),s).replace(new RegExp(fakeHostName,"g"),t),e=r?btoa(e):e}async function MD5MD5(e){var s=new TextEncoder,e=await crypto.subtle.digest("MD5",s.encode(e)),e=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join(""),s=await crypto.subtle.digest("MD5",s.encode(e.slice(7,27)));return Array.from(new Uint8Array(s)).map(e=>e.toString(16).padStart(2,"0")).join("").toLowerCase()}async function ADD(e){e=e.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");return(e=","==(e=","==e.charAt(0)?e.slice(1):e).charAt(e.length-1)?e.slice(0,e.length-1):e).split(",")}let 啥啥啥_写的这是啥啊="dmxlc3M=";function 配置信息(e,s){var t=atob(啥啥啥_写的这是啥啊),r=FileName;let a=s,o=443;var n=s,i="/?ed=2560";let c=["tls",!0];var l=s,d="randomized",s=(s.includes(".workers.dev")&&(a="visa.cn",o=80,c=["",!1]),`${t}://${e}@${a}:${o}?encryption=none&security=${c[0]}&sni=${l}&fp=${d}&type=ws&host=${n}&path=${encodeURIComponent(i)}#`+encodeURIComponent(r));return[s,`- type: ${t}
  name: ${FileName}
  server: ${a}
  port: ${o}
  uuid: ${e}
  network: ws
  tls: ${c[1]}
  udp: false
  sni: ${l}
  client-fingerprint: ${d}
  ws-opts:
    path: "${i}"
    headers:
      host: `+n]}let subParams=["sub","base64","b64","clash","singbox","sb"];async function getVLESSConfig(i,c,l,d,u,p){var e=d.toLowerCase(),t=配置信息(i,c),r=t[0],t=t[1];let a="";if(c.includes(".workers.dev")||c.includes(".pages.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{var o=await fetch(proxyhostsURL);if(!o.ok)return void console.error("获取地址时出错:",o.status,o.statusText);var s=(await o.text()).split("\n").filter(e=>""!==e.trim());proxyhosts=proxyhosts.concat(s)}catch(e){}0!=proxyhosts.length&&(a=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(e.includes("mozilla")&&!subParams.some(e=>p.searchParams.has(e))){o=socks5s.map(e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e);let e="",s=(0<go2Socks5s.length&&enableSocks&&(e=""+decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20"),go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?e+=decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")+`
`:e+=`
  ${go2Socks5s.join("\n  ")}
`),"");return l&&""!=l?(enableSocks?s+=`CFCDN（访问方式）: Socks5
  ${o.join("\n  ")}
`+e:proxyIP&&""!=proxyIP?s+=`CFCDN（访问方式）: ProxyIP
  ${proxyIPs.join("\n  ")}
`:s+="true"==u?`CFCDN（访问方式）: 自动获取ProxyIP
`:`CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！
`,s+=`
SUB（优选订阅生成器）: `+l):(enableSocks?s+=`CFCDN（访问方式）: Socks5
  ${o.join("\n  ")}
`+e:proxyIP&&""!=proxyIP?s+=`CFCDN（访问方式）: ProxyIP
  ${proxyIPs.join("\n  ")}
`:s+=`CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！
`,s+=`
您的订阅内容由 内置 addresses/ADD* 参数变量提供
`,0<addresses.length&&(s+=`ADD（TLS优选域名&IP）: 
  ${addresses.join("\n  ")}
`),0<addressesnotls.length&&(s+=`ADDNOTLS（noTLS优选域名&IP）: 
  ${addressesnotls.join("\n  ")}
`),0<addressesapi.length&&(s+=`ADDAPI（TLS优选域名&IP 的 API）: 
  ${addressesapi.join("\n  ")}
`),0<addressesnotlsapi.length&&(s+=`ADDNOTLSAPI（noTLS优选域名&IP 的 API）: 
  ${addressesnotlsapi.join("\n  ")}
`),0<addressescsv.length&&(s+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: 
  ${addressescsv.join("\n  ")}
`)),`
################################################################
Subscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式
---------------------------------------------------------------
快速自适应订阅地址:
https://${a}${c}/${i}
https://${a}${c}/${i}?sub

Base64订阅地址:
https://${a}${c}/${i}?b64
https://${a}${c}/${i}?base64

clash订阅地址:
https://${a}${c}/${i}?clash

singbox订阅地址:
https://${a}${c}/${i}?sb
https://${a}${c}/${i}?singbox
---------------------------------------------------------------
################################################################
${FileName} 配置信息
---------------------------------------------------------------
HOST: ${c}
UUID: ${i}
FKID: ${fakeUserID}
UA: ${d}

${s}
SUBAPI（订阅转换后端）: ${subProtocol}://${subconverter}
SUBCONFIG（订阅转换配置文件）: ${subconfig}
---------------------------------------------------------------
################################################################
v2ray
---------------------------------------------------------------
${r}
---------------------------------------------------------------
################################################################
clash-meta
---------------------------------------------------------------
${t}
---------------------------------------------------------------
################################################################
telegram 交流群 技术大佬~在线发牌!
https://t.me/CMLiussss
---------------------------------------------------------------
github 项目地址 Star!Star!Star!!!
https://github.com/cmliu/edgetunnel
---------------------------------------------------------------
################################################################
`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";let s=[],t=[],r=[],a=[],o=(c.includes(".workers.dev")?(noTLS="true",fakeHostName+=".workers.dev",r=await getAddressesapi(addressesnotlsapi),a=await getAddressescsv("FALSE")):c.includes(".pages.dev")?fakeHostName+=".pages.dev":c.includes("worker")||c.includes("notls")||"true"==noTLS?(noTLS="true",fakeHostName=`notls${fakeHostName}.net`,r=await getAddressesapi(addressesnotlsapi),a=await getAddressescsv("FALSE")):fakeHostName+=".xyz",console.log("虚假HOST: "+fakeHostName),`${subProtocol}://${l}/sub?host=${fakeHostName}&uuid=${fakeUserID}&edgetunnel=cmliu&proxyip=`+u),n=!0;if(!l||""==l){if(c.includes("workers.dev")||c.includes("pages.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{var h=await fetch(proxyhostsURL);if(!h.ok)return void console.error("获取地址时出错:",h.status,h.statusText);var f=(await h.text()).split("\n").filter(e=>""!==e.trim());proxyhosts=proxyhosts.concat(f)}catch(e){console.error("获取地址时出错:",e)}proxyhosts=[...new Set(proxyhosts)]}s=await getAddressesapi(addressesapi),t=await getAddressescsv("TRUE"),o=`https://${c}/`+fakeUserID,(c.includes("worker")||c.includes("notls")||"true"==noTLS)&&(o+="?notls"),console.log("虚假订阅: "+o)}e.includes("CF-Workers-SUB".toLowerCase())||(e.includes("clash")&&!e.includes("nekobox")||p.searchParams.has("clash")&&!e.includes("subconverter")?(o=`${subProtocol}://${subconverter}/sub?target=clash&url=${encodeURIComponent(o)}&insert=false&config=${encodeURIComponent(subconfig)}&emoji=true&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,n=!1):(e.includes("sing-box")||e.includes("singbox")||(p.searchParams.has("singbox")||p.searchParams.has("sb"))&&!e.includes("subconverter"))&&(o=`${subProtocol}://${subconverter}/sub?target=singbox&url=${encodeURIComponent(o)}&insert=false&config=${encodeURIComponent(subconfig)}&emoji=true&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,n=!1));try{let e;return e=l&&""!=l||1!=n?await(await fetch(o,{headers:{"User-Agent":d+" CF-Workers-edgetunnel/cmliu"}})).text():await subAddresses(fakeHostName,fakeUserID,noTLS,s,t,r,a),p.pathname=="/"+fakeUserID?e:revertFakeInfo(e,i,c,n)}catch(e){return console.error("Error fetching content:",e),"Error fetching content: "+e.message}}}async function getAccountId(e,s){try{var t=new Headers({"X-AUTH-EMAIL":e,"X-AUTH-KEY":s});return(await(await fetch("https://api.cloudflare.com/client/v4/accounts",{headers:t})).json()).result[0].id}catch(e){return!1}}async function getSum(e,s,t,r,a,o){try{var n=new Date(a).toISOString(),i=new Date(o).toISOString(),c=JSON.stringify({query:`query getBillingMetrics($accountId: String!, $filter: AccountWorkersInvocationsAdaptiveFilter_InputObject) {
				viewer {
					accounts(filter: {accountTag: $accountId}) {
						pagesFunctionsInvocationsAdaptiveGroups(limit: 1000, filter: $filter) {
							sum {
								requests
							}
						}
						workersInvocationsAdaptive(limit: 10000, filter: $filter) {
							sum {
								requests
							}
						}
					}
				}
			}`,variables:{accountId:e,filter:{datetime_geq:n,datetime_leq:i}}}),l=new Headers({"Content-Type":"application/json","X-AUTH-EMAIL":t,"X-AUTH-KEY":r}),d=await fetch("https://api.cloudflare.com/client/v4/graphql",{method:"POST",headers:l,body:c});if(!d.ok)throw new Error("HTTP error! status: "+d.status);var u=await d.json(),p=u?.data?.viewer?.accounts?.[s]?.pagesFunctionsInvocationsAdaptiveGroups,h=u?.data?.viewer?.accounts?.[s]?.workersInvocationsAdaptive;if(p||h)return[p.reduce((e,s)=>e+s?.sum.requests,0),h.reduce((e,s)=>e+s?.sum.requests,0)];throw new Error("找不到数据")}catch(e){return[0,0]}}async function getAddressesapi(e){if(!e||0===e.length)return[];let s="",t=new AbortController;var r,a,o=setTimeout(()=>{t.abort()},2e3);try{for(r of await Promise.allSettled(e.map(e=>fetch(e,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":"CF-Workers-edgetunnel/cmliu"},signal:t.signal}).then(e=>e.ok?e.text():Promise.reject()))))"fulfilled"===r.status&&(a=await r.value,s+=a+"\n")}catch(e){console.error(e)}finally{clearTimeout(o)}return await ADD(s)}async function getAddressescsv(t){if(!addressescsv||0===addressescsv.length)return[];var e,r=[];for(e of addressescsv)try{var a=await fetch(e);if(a.ok){var o=await a.text();let s;var n=(s=o.includes("\r\n")?o.split("\r\n"):o.split("\n"))[0].split(",").indexOf("TLS"),i=n+1;if(-1===n)console.error("CSV文件缺少必需的字段");else for(let e=1;e<s.length;e++){var c,l,d,u=s[e].split(","),p=u.length-1;u[n].toUpperCase()===t&&parseFloat(u[p])>DLS&&(c=u[0],l=u[1],d=u[i],r.push(c+`:${l}#`+d))}}else console.error("获取CSV地址时出错:",a.status,a.statusText)}catch(e){console.error("获取CSV地址时出错:",e);continue}return r}function subAddresses(c,l,e,s,t,r,a){let d=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;addresses=(addresses=addresses.concat(s)).concat(t);let o;"true"==e&&(addressesnotls=(addressesnotls=addressesnotls.concat(r)).concat(a),s=[...new Set(addressesnotls)],o=s.map(e=>{let s="80",t=e;var r=t.match(d);r?(e=r[1],s=r[2]||s,t=r[3]||e):(e.includes(":")&&e.includes("#")?(e=(r=e.split(":"))[0],r=r[1].split("#"),s=r[0],t=r[1]):e.includes(":")?(e=(r=e.split(":"))[0],s=r[1]):e.includes("#")&&(e=(r=e.split("#"))[0],t=r[1]),t.includes(":")&&(t=t.split(":")[0]));if(!isValidIPv4(e)&&"80"==s)for(var a of["8080","8880","2052","2082","2086","2095"])if(e.includes(a)){s=a;break}r=c;return`${atob(啥啥啥_写的这是啥啊)}://${l}@${e}:${s}?encryption=none&security=&type=ws&host=${r}&path=${encodeURIComponent("/?ed=2560")}#`+encodeURIComponent(t+"")}).join("\n"));let n=[...new Set(addresses)].map(e=>{let s="443",t=e;var r=t.match(d);r?(e=r[1],s=r[2]||s,t=r[3]||e):(e.includes(":")&&e.includes("#")?(e=(r=e.split(":"))[0],r=r[1].split("#"),s=r[0],t=r[1]):e.includes(":")?(e=(r=e.split(":"))[0],s=r[1]):e.includes("#")&&(e=(r=e.split("#"))[0],t=r[1]),t.includes(":")&&(t=t.split(":")[0]));if(!isValidIPv4(e)&&"443"==s)for(var a of["2053","2083","2087","2096","8443"])if(e.includes(a)){s=a;break}let o=c,n="/?ed=2560",i="";return 0<proxyhosts.length&&(o.includes(".workers.dev")||o.includes("pages.dev"))&&(n="/"+o+n,o=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],i=" 已启用临时域名中转服务，请尽快绑定自定义域！"),`${atob(啥啥啥_写的这是啥啊)}://${l}@${e}:${s}?encryption=none&security=tls&sni=${o}&fp=random&type=ws&host=${o}&path=${encodeURIComponent(n)}#`+encodeURIComponent(t+i)}).join("\n");return"true"==e&&(n+=`
`+o),btoa(n)}async function sendMessage(s,t,r=""){if(""!==BotToken&&""!==ChatID){let e="";var a=await fetch(`http://ip-api.com/json/${t}?lang=zh-CN`),a=(e=200==a.status?`${s}
IP: ${t}
国家: ${(a=await a.json()).country}
<tg-spoiler>城市: ${a.city}
组织: ${a.org}
ASN: ${a.as}
`+r:s+`
IP: ${t}
<tg-spoiler>`+r,"https://api.telegram.org/bot"+BotToken+"/sendMessage?chat_id="+ChatID+"&parse_mode=HTML&text="+encodeURIComponent(e));return fetch(a,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}}function isValidIPv4(e){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}
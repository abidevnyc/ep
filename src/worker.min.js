import{connect}from"cloudflare:sockets";let sha224Password="08f32643dbdacf81d0d511f1ee24b06de759e90f8edf742bbdc57d88",proxyIP="";if(!isValidSHA224(sha224Password))throw new Error("sha224Password is not valid");let worker_default={async fetch(e,r,a){try{proxyIP=r.PROXYIP||proxyIP,sha224Password=r.SHA224PASS||sha224Password;var t,o=e.headers.get("Upgrade");return o&&"websocket"===o?await trojanOverWSHandler(e,r):"/link"!==new URL(e.url).pathname?new Response("404 Not found",{status:404}):(t=e.headers.get("Host"),new Response(`trojan://ca110us@${t}:443/?type=ws&host=${t}&security=tls`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}}))}catch(e){return new Response(e.toString())}}};async function trojanOverWSHandler(e,n){var r=new WebSocketPair;let[a,c]=Object.values(r),l=(c.accept(),""),i="",d=(e,r)=>{console.log(`[${l}:${i}] `+e,r||"")};r=e.headers.get("sec-websocket-protocol")||"",e=makeReadableWebSocketStream(c,r,d);let u={value:null};return e.pipeTo(new WritableStream({async write(e,r){if(u.value)await(a=u.value.writable.getWriter()).write(e),a.releaseLock();else{var{hasError:a,message:e,portRemote:t=443,addressRemote:o="",rawClientData:s}=await parseTrojanHeader(e);if(l=o,i=`${t}--${Math.random()} tcp`,a)throw new Error(e);handleTCPOutBound(u,o,t,s,c,d,n)}},close(){d("readableWebSocketStream is closed")},abort(e){d("readableWebSocketStream is aborted",JSON.stringify(e))}})).catch(e=>{d("readableWebSocketStream pipeTo error",e)}),new Response(null,{status:101,webSocket:a})}async function parseTrojanHeader(e){if(e.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(e.slice(56,57))[0]||10!==new Uint8Array(e.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(e.slice(0,56))!==sha224Password)return{hasError:!0,message:"invalid password"};var r=e.slice(58);if(r.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};e=new DataView(r);if(1!==e.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};var a,t=e.getUint8(1);let o=0,s=2,n="";switch(t){case 1:o=4,n=new Uint8Array(r.slice(s,s+o)).join(".");break;case 3:o=new Uint8Array(r.slice(s,s+1))[0],s+=1,n=(new TextDecoder).decode(r.slice(s,s+o));break;case 4:o=16;var c=new DataView(r.slice(s,s+o)),l=[];for(let e=0;e<8;e++)l.push(c.getUint16(2*e).toString(16));n=l.join(":");break;default:return{hasError:!0,message:"invalid addressType is "+t}}return n?(e=s+o,a=r.slice(e,e+2),a=new DataView(a).getUint16(0),{hasError:!1,addressRemote:n,portRemote:a,rawClientData:r.slice(e+4)}):{hasError:!0,message:"address is empty, addressType is "+t}}async function handleTCPOutBound(o,r,a,s,t,n,c){async function l(e,r){var a=c.SNI||"example.com",t=connect({hostname:e,port:r,servername:a}),e=(o.value=t,n(`connected to ${e}:${r} with SNI `+a),t.writable.getWriter());return await e.write(s),e.releaseLock(),t}remoteSocketToWS(await l(r,a),t,async function(){var e=await l(proxyIP||r,a);e.closed.catch(e=>{console.log("retry tcpSocket closed error",e)}).finally(()=>{safeCloseWebSocket(t)}),remoteSocketToWS(e,t,null,n)},n)}function makeReadableWebSocketStream(t,o,s){let n=!1;return new ReadableStream({start(r){t.addEventListener("message",e=>{n||(e=e.data,r.enqueue(e))}),t.addEventListener("close",()=>{safeCloseWebSocket(t),n||r.close()}),t.addEventListener("error",e=>{s("webSocketServer error"),r.error(e)});var{earlyData:e,error:a}=base64ToArrayBuffer(o);a?r.error(a):e&&r.enqueue(e)},pull(e){},cancel(e){n||(s("readableStream was canceled, due to "+e),n=!0,safeCloseWebSocket(t))}})}async function remoteSocketToWS(e,a,r,t){let o=!1;await e.readable.pipeTo(new WritableStream({async write(e,r){o=!0,a.readyState!==WS_READY_STATE_OPEN&&r.error("webSocket connection is not open"),a.send(e)},close(){t("remoteSocket.readable is closed, hasIncomingData: "+o)},abort(e){console.error("remoteSocket.readable abort",e)}})).catch(e=>{console.error("remoteSocketToWS error:",e.stack||e),safeCloseWebSocket(a)}),!1===o&&r&&(t("retry"),r())}function isValidSHA224(e){return/^[0-9a-f]{56}$/i.test(e)}function base64ToArrayBuffer(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");var r=atob(e);return{earlyData:Uint8Array.from(r,e=>e.charCodeAt(0)).buffer,error:null}}catch(e){return{error:e}}}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}export{worker_default as default};
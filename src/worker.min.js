import{connect}from"cloudflare:sockets";let userID="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1,fakeUserID,fakeHostName,noTLS="false",expire=4102329600,proxyIPs,socks5s,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressesnotls=[],addressesnotlsapi=[],addressescsv=[],DLS=8,FileName=atob("ZWRnZXR1bm5lbA=="),BotToken,ChatID,proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"],有效时间=7,更新时间=3,userIDLow,userIDTime="",proxyIPPool=[],path="/?ed=2560";export default{async fetch(e,s,t){try{var r,a=e.headers.get("User-Agent")||"null",o=a.toLowerCase();if(s.KEY?(有效时间=s.TIME||有效时间,更新时间=s.UPTIME||更新时间,r=await 生成动态UUID(s.KEY),userID=r[0]):s.UUID&&(userID=s.UUID),"0"==(subEmoji=s.SUBEMOJI||s.EMOJI||subEmoji)&&(subEmoji="false"),!userID)return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});var n=new Date,l=(n.setHours(0,0,0,0),Math.ceil(n.getTime()/1e3)),i=await 双重哈希(""+userID+l);if(fakeUserID=[i.slice(0,8),i.slice(8,12),i.slice(12,16),i.slice(16,20),i.slice(20)].join("-"),fakeHostName=i.slice(6,9)+"."+i.slice(13,19),proxyIP=s.PROXYIP||proxyIP,proxyIPs=await 整理(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=s.SOCKS5||socks5Address,socks5s=await 整理(socks5Address),socks5Address=(socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)]).split("//")[1]||socks5Address,s.CFPORTS&&(httpsPorts=await 整理(s.CFPORTS)),sub=s.SUB||sub,(subConverter=s.SUBAPI||subConverter).includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=s.SUBCONFIG||subConfig,socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=s.RPROXYIP||"false",enableSocks=!0}catch(e){var c=e;console.log(c.toString()),RproxyIP=s.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=s.RPROXYIP||!proxyIP?"true":"false";s.ADD&&(addresses=await 整理(s.ADD)),s.ADDAPI&&(addressesapi=await 整理(s.ADDAPI)),s.ADDNOTLS&&(addressesnotls=await 整理(s.ADDNOTLS)),s.ADDNOTLSAPI&&(addressesnotlsapi=await 整理(s.ADDNOTLSAPI)),s.ADDCSV&&(addressescsv=await 整理(s.ADDCSV)),DLS=s.DLS||DLS,BotToken=s.TGTOKEN||BotToken,ChatID=s.TGID||ChatID,s.GO2SOCKS5&&(go2Socks5s=await 整理(s.GO2SOCKS5));var d,p,u,h,S,f,m,y,b=e.headers.get("Upgrade"),w=new URL(e.url);if(w.searchParams.has("sub")&&""!==w.searchParams.get("sub")&&(sub=w.searchParams.get("sub")),FileName=s.SUBNAME||FileName,w.searchParams.has("notls")&&(noTLS="true"),b&&"websocket"===b){if(socks5Address=w.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(w.pathname))socks5Address=w.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(w.pathname)||new RegExp("/socks5://","i").test(w.pathname))&&(socks5Address=w.pathname.split("://")[1].split("#")[0]).includes("@")){let e=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(e)&&!e.includes(":")&&(e=atob(e)),socks5Address=e+"@"+socks5Address.split("@")[1]}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(e){var g=e;console.log(g.toString()),enableSocks=!1}else enableSocks=!1;return w.searchParams.has("proxyip")?(proxyIP=w.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(w.pathname)?(proxyIP=w.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(w.pathname)&&(proxyIP="proxyip."+w.pathname.toLowerCase().split("/proxyip.")[1],enableSocks=!1),await vlessOverWSHandler(e)}return w.searchParams.has("proxyip")?(path="/?ed=2560&proxyip="+w.searchParams.get("proxyip"),RproxyIP="false"):w.searchParams.has("socks5")?(path="/?ed=2560&socks5="+w.searchParams.get("socks5"),RproxyIP="false"):w.searchParams.has("socks")&&(path="/?ed=2560&socks5="+w.searchParams.get("socks"),RproxyIP="false"),"/"==(d=w.pathname.toLowerCase())?s.URL302?Response.redirect(s.URL302,302):s.URL?await 代理URL(s.URL,w):new Response(JSON.stringify(e.cf,null,4),{status:200,headers:{"content-type":"application/json"}}):d=="/"+fakeUserID?(p=await 生成配置信息(userID,e.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,w,s),new Response(""+p,{status:200})):d=="/"+s.KEY||d=="/"+userID?(await sendMessage("#获取订阅 "+FileName,e.headers.get("CF-Connecting-IP"),`UA: ${a}</tg-spoiler>
域名: ${w.hostname}
<tg-spoiler>入口: ${w.pathname+w.search}</tg-spoiler>`),u=await 生成配置信息(userID,e.headers.get("Host"),sub,a,RproxyIP,w,s),h=Date.now(),(S=new Date(h)).setHours(0,0,0,0),m=f=Math.floor((h-S.getTime())/864e5*24*1099511627776/2),y=26388279066624,o&&o.includes("mozilla")?new Response(""+u,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${f}; download=${m}; total=${y}; expire=`+expire}}):new Response(""+u,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''`+encodeURIComponent(FileName),"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${f}; download=${m}; total=${y}; expire=`+expire}})):s.URL302?Response.redirect(s.URL302,302):s.URL?await 代理URL(s.URL,w):new Response("",{status:404})}catch(e){return new Response(e.toString())}}};async function vlessOverWSHandler(e){var s=new WebSocketPair;let[t,d]=Object.values(s),p=(d.accept(),""),u="",h=(e,s)=>{console.log(`[${p}:${u}] `+e,s||"")};s=e.headers.get("sec-websocket-protocol")||"",e=makeReadableWebSocketStream(d,s,h);let S={value:null},f=!1;return e.pipeTo(new WritableStream({async write(e,s){if(f)return handleDNSQuery(e,d,null,h);if(S.value)await(t=S.value.writable.getWriter()).write(e),t.releaseLock();else{var{hasError:t,message:r,addressType:a,portRemote:o=443,addressRemote:n="",rawDataIndex:l,vlessVersion:i=new Uint8Array([0,0]),isUDP:c}=processVlessHeader(e,userID);if(p=n,u=`${o}--${Math.random()} ${c?"udp ":"tcp "} `,t)throw new Error(r);if(c){if(53!==o)throw new Error("UDP 代理仅对 DNS（53 端口）启用");f=!0}t=new Uint8Array([i[0],0]),r=e.slice(l);if(f)return handleDNSQuery(r,d,t,h);h(`处理 TCP 出站连接 ${n}:`+o),handleTCPOutBound(S,a,n,o,r,d,t,h)}},close(){h("readableWebSocketStream 已关闭")},abort(e){h("readableWebSocketStream 已中止",JSON.stringify(e))}})).catch(e=>{h("readableWebSocketStream 管道错误",e)}),new Response(null,{status:101,webSocket:t})}async function handleTCPOutBound(r,a,e,s,o,t,n,l){async function i(e,s,t=!1){l(`connected to ${e}:`+s);t=t?await socks5Connect(a,e,s,l):connect({hostname:e,port:s}),e=(r.value=t).writable.getWriter();return await e.write(o),e.releaseLock(),t}let c=!1;var d;0<go2Socks5s.length&&enableSocks&&(c=(d=e,await(!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some(e=>{e=e.replace(/\*/g,".*");return new RegExp(`^${e}$`,"i").test(d)}))));let p=await i(e,s,c);remoteSocketToWS(p,t,n,async function(){(p=enableSocks?await i(e,s,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(s=proxyIP.split("]:")[1]||s,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(s=proxyIP.split(":")[1]||s,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(s=proxyIP.split(".tp")[1].split(".")[0]||s),await i(proxyIP||e,s))).closed.catch(e=>{console.log("retry tcpSocket closed error",e)}).finally(()=>{safeCloseWebSocket(t)}),remoteSocketToWS(p,t,n,null,l)},l)}function makeReadableWebSocketStream(r,a,o){let n=!1;return new ReadableStream({start(s){r.addEventListener("message",e=>{n||(e=e.data,s.enqueue(e))}),r.addEventListener("close",()=>{safeCloseWebSocket(r),n||s.close()}),r.addEventListener("error",e=>{o("WebSocket 服务器发生错误"),s.error(e)});var{earlyData:e,error:t}=base64ToArrayBuffer(a);t?s.error(t):e&&s.enqueue(e)},pull(e){},cancel(e){n||(o("可读流被取消，原因是 "+e),n=!0,safeCloseWebSocket(r))}})}function processVlessHeader(e,s){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};var t=new Uint8Array(e.slice(0,1));let r=!1;if(s=s,o=userIDLow,a=e,!((a=stringify(new Uint8Array(a.slice(1,17))))===s||a===o))return{hasError:!0,message:"invalid user "+new Uint8Array(e.slice(1,17))};var s=new Uint8Array(e.slice(17,18))[0],a=new Uint8Array(e.slice(18+s,18+s+1))[0];if(1!==a){if(2!==a)return{hasError:!0,message:`command ${a} is not support, command 01-tcp,02-udp,03-mux`};r=!0}var o=18+s+1,a=e.slice(o,o+2),s=new DataView(a).getUint16(0),a=o+2,n=new Uint8Array(e.slice(a,a+1))[0];let l=0,i=a+1,c="";switch(n){case 1:l=4,c=new Uint8Array(e.slice(i,i+l)).join(".");break;case 2:l=new Uint8Array(e.slice(i,i+1))[0],i+=1,c=(new TextDecoder).decode(e.slice(i,i+l));break;case 3:l=16;var d=new DataView(e.slice(i,i+l)),p=[];for(let e=0;e<8;e++)p.push(d.getUint16(2*e).toString(16));c=p.join(":");break;default:return{hasError:!0,message:"invild addressType is "+n}}return c?{hasError:!1,addressRemote:c,addressType:n,portRemote:s,rawDataIndex:i+l,vlessVersion:t,isUDP:r}:{hasError:!0,message:"addressValue is empty, addressType is "+n}}async function remoteSocketToWS(e,t,s,r,a){let o=s,n=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,s){n=!0,t.readyState!==WS_READY_STATE_OPEN&&s.error("webSocket.readyState is not open, maybe close"),o?(t.send(await new Blob([o,e]).arrayBuffer()),o=null):t.send(e)},close(){a("remoteConnection!.readable is close with hasIncomingData is "+n)},abort(e){console.error("remoteConnection!.readable abort",e)}})).catch(e=>{console.error("remoteSocketToWS has exception ",e.stack||e),safeCloseWebSocket(t)}),!1===n&&r&&(a("retry"),r())}function base64ToArrayBuffer(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");var s=atob(e);return{earlyData:Uint8Array.from(s,e=>e.charCodeAt(0)).buffer,error:null}}catch(e){return{error:e}}}function isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}let byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,s=0){return(byteToHex[e[s+0]]+byteToHex[e[s+1]]+byteToHex[e[s+2]]+byteToHex[e[s+3]]+"-"+byteToHex[e[s+4]]+byteToHex[e[s+5]]+"-"+byteToHex[e[s+6]]+byteToHex[e[s+7]]+"-"+byteToHex[e[s+8]]+byteToHex[e[s+9]]+"-"+byteToHex[e[s+10]]+byteToHex[e[s+11]]+byteToHex[e[s+12]]+byteToHex[e[s+13]]+byteToHex[e[s+14]]+byteToHex[e[s+15]]).toLowerCase()}function stringify(e,s=0){e=unsafeStringify(e,s);if(isValidUUID(e))return e;throw TypeError("生成的 UUID 不符合规范 "+e)}async function handleDNSQuery(e,r,a,o){try{let s="8.8.4.4";let t=a;var n=connect({hostname:s,port:53}),l=(o(`连接到 ${s}:53`),n.writable.getWriter());await l.write(e),l.releaseLock(),await n.readable.pipeTo(new WritableStream({async write(e){r.readyState===WS_READY_STATE_OPEN&&(t?(r.send(await new Blob([t,e]).arrayBuffer()),t=null):r.send(e))},close(){o(`DNS 服务器(${s}) TCP 连接已关闭`)},abort(e){console.error(`DNS 服务器(${s}) TCP 连接异常中断`,e)}}))}catch(e){console.error("handleDNSQuery 函数发生异常，错误信息: "+e.message)}}async function socks5Connect(s,t,r,a){var{username:o,password:n,hostname:l,port:i}=parsedSocks5Address,l=connect({hostname:l,port:i}),i=new Uint8Array([5,2,0,2]),c=l.writable.getWriter(),i=(await c.write(i),a("已发送 SOCKS5 问候消息"),l.readable.getReader()),d=new TextEncoder;let p=(await i.read()).value;if(5!==p[0])a(`SOCKS5 服务器版本错误: 收到 ${p[0]}，期望是 5`);else if(255===p[1])a("服务器不接受任何认证方法");else{if(2===p[1]){if(a("SOCKS5 服务器需要认证"),!o||!n)return void a("请提供用户名和密码");o=new Uint8Array([1,o.length,...d.encode(o),n.length,...d.encode(n)]);if(await c.write(o),1!==(p=(await i.read()).value)[0]||0!==p[1])return void a("SOCKS5 服务器认证失败")}let e;switch(s){case 1:e=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:e=new Uint8Array([3,t.length,...d.encode(t)]);break;case 3:e=new Uint8Array([4,...t.split(":").flatMap(e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)])]);break;default:return void a("无效的地址类型: "+s)}n=new Uint8Array([5,1,0,...e,r>>8,255&r]);if(await c.write(n),a("已发送 SOCKS5 请求"),0===(p=(await i.read()).value)[1])return a("SOCKS5 连接已建立"),c.releaseLock(),i.releaseLock(),l;a("SOCKS5 连接建立失败")}}function socks5AddressParser(e){var[e,s]=e.split("@").reverse();let t,r,a,o;if(s){s=s.split(":");if(2!==s.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[t,r]=s}s=e.split(":");if(o=Number(s.pop()),isNaN(o))throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");if((a=s.join(":")).includes(":")&&!/^\[.*\]$/.test(a))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:t,password:r,hostname:a,port:o}}function 恢复伪装信息(e,s,t,r){return e=(e=r?atob(e):e).replace(new RegExp(fakeUserID,"g"),s).replace(new RegExp(fakeHostName,"g"),t),e=r?btoa(e):e}async function 双重哈希(e){var s=new TextEncoder,e=await crypto.subtle.digest("MD5",s.encode(e)),e=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join(""),s=await crypto.subtle.digest("MD5",s.encode(e.slice(7,27)));return Array.from(new Uint8Array(s)).map(e=>e.toString(16).padStart(2,"0")).join("").toLowerCase()}async function 代理URL(e,s){var e=await 整理(e),e=e[Math.floor(Math.random()*e.length)],e=new URL(e),t=(console.log(e),e.protocol.slice(0,-1)||"https"),r=e.hostname;let a=e.pathname;e=e.search,"/"==a.charAt(a.length-1)&&(a=a.slice(0,-1)),t=t+"://"+r+(a+=s.pathname)+e,r=await fetch(t),s=new Response(r.body,{status:r.status,statusText:r.statusText,headers:r.headers});return s.headers.set("X-New-URL",t),s}let 啥啥啥_写的这是啥啊=atob("ZG14bGMzTT0=");function 配置信息(e,s){var t=atob(啥啥啥_写的这是啥啊),r=FileName;let a=s,o=443;var n=s,l=path;let i=["tls",!0];var c=s,d="randomized",s=(s.includes(".workers.dev")&&(a=atob("dmlzYS5jbg=="),o=80,i=["",!1]),""+t+`://${e}@${a}:${o}?encry`+"p"+atob("dGlvbj0=")+"none"+`&security=${i[0]}&sni=${c}&fp=${d}&type=ws&host=${n}&path=${encodeURIComponent(l)}#`+encodeURIComponent(r));return[s,`- type: ${t}
  name: ${FileName}
  server: ${a}
  port: ${o}
  uuid: ${e}
  network: ws
  tls: ${i[1]}
  udp: false
  sni: ${c}
  client-fingerprint: ${d}
  ws-opts:
	path: "${l}"
	headers:
	  host: `+n]}let subParams=["sub","base64","b64","clash","singbox","sb"];async function 生成配置信息(l,i,c,d,p,u,t){function s(e){var[e,s]=e.split("/"),e=e.split(".").map(Number);let t=32-parseInt(s,10);s=Math.pow(2,t)-1;let r=Math.floor(Math.random()*s);return e.map((e,s)=>s<2?e:2===s?(e&255<<t-8)+(r>>8&255):(e&255<<t)+(255&r)).join(".")}c?1<(r=整理(c=(r=c.match(/^(?:https?:\/\/)?([^\/]+)/))?r[1]:c)).length&&(c=r[0]):addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length==0&&(r=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"],addresses=addresses.concat("127.0.0.1:1234#CFnat"),i.includes(".workers.dev")?addressesnotls=addressesnotls.concat(r.map(e=>s(e)+"#CF随机节点")):addresses=addresses.concat(r.map(e=>s(e)+"#CF随机节点")));var r=u.pathname=="/"+t.KEY?t.KEY:l,e=d.toLowerCase(),a=配置信息(l,i),o=a[0],a=a[1];let n="";if(i.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{var h=await fetch(proxyhostsURL);if(!h.ok)return void console.error("获取地址时出错:",h.status,h.statusText);var S=(await h.text()).split("\n").filter(e=>""!==e.trim());proxyhosts=proxyhosts.concat(S)}catch(e){}0!=proxyhosts.length&&(n=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(e.includes("mozilla")&&!subParams.some(e=>u.searchParams.has(e))){h=socks5s.map(e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e);let e="",s=(0<go2Socks5s.length&&enableSocks&&(e=""+decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20"),go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?e+=decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")+`
`:e+=`
  ${go2Socks5s.join("\n  ")}
`),"\n");c?(enableSocks?s+=`CFCDN（访问方式）: Socks5
  ${h.join("\n  ")}
`+e:proxyIP&&""!=proxyIP?s+=`CFCDN（访问方式）: ProxyIP
  ${proxyIPs.join("\n  ")}
`:s+="true"==p?`CFCDN（访问方式）: 自动获取ProxyIP
`:`CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！
`,s+=`
SUB（优选订阅生成器）: `+c):(enableSocks?s+=`CFCDN（访问方式）: Socks5
  ${h.join("\n  ")}
`+e:proxyIP&&""!=proxyIP?s+=`CFCDN（访问方式）: ProxyIP
  ${proxyIPs.join("\n  ")}
`:s+=`CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！
`,s+=`
您的订阅内容由 内置 addresses/ADD* 参数变量提供
`,0<addresses.length&&(s+=`ADD（TLS优选域名&IP）: 
  ${addresses.join("\n  ")}
`),0<addressesnotls.length&&(s+=`ADDNOTLS（noTLS优选域名&IP）: 
  ${addressesnotls.join("\n  ")}
`),0<addressesapi.length&&(s+=`ADDAPI（TLS优选域名&IP 的 API）: 
  ${addressesapi.join("\n  ")}
`),0<addressesnotlsapi.length&&(s+=`ADDNOTLSAPI（noTLS优选域名&IP 的 API）: 
  ${addressesnotlsapi.join("\n  ")}
`),0<addressescsv.length&&(s+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: 
  ${addressescsv.join("\n  ")}
`)),t.KEY&&u.pathname!=="/"+t.KEY?s="":s+=`
SUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}
SUBCONFIG（订阅转换配置文件）: `+subConfig;S=r!=l?`TOKEN: ${r}
UUIDNow: ${l}
UUIDLow: ${userIDLow}
${userIDTime}TIME（动态UUID有效时间）: ${有效时间} 天
UPTIME（动态UUID更新时间）: ${更新时间} 时（北京时间）

`:""+userIDTime;return`
################################################################
Subscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式
---------------------------------------------------------------
快速自适应订阅地址:
https://${n}${i}/${r}
https://${n}${i}/${r}?sub

Base64订阅地址:
https://${n}${i}/${r}?b64
https://${n}${i}/${r}?base64

clash订阅地址:
https://${n}${i}/${r}?clash

singbox订阅地址:
https://${n}${i}/${r}?sb
https://${n}${i}/${r}?singbox
---------------------------------------------------------------
################################################################
${FileName} 配置信息
---------------------------------------------------------------
${S}HOST: ${i}
UUID: ${l}
FKID: ${fakeUserID}
UA: ${d}
${s}
---------------------------------------------------------------
################################################################
v2ray
---------------------------------------------------------------
${o}
---------------------------------------------------------------
################################################################
clash-meta
---------------------------------------------------------------
${a}
---------------------------------------------------------------
################################################################
${decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhCmh0dHBzJTNBJTJGJTJGdC5tZSUyRkNNTGl1c3NzcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISEKaHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGY21saXUlMkZlZGdldHVubmVsCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQolMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjM="))}
`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";let s=[],t=[],r=[],a=[],o=(i.includes(".workers.dev")?(noTLS="true",fakeHostName+=".workers.dev",r=await 整理优选列表(addressesnotlsapi),a=await 整理测速结果("FALSE")):i.includes(".pages.dev")?fakeHostName+=".pages.dev":i.includes("worker")||i.includes("notls")||"true"==noTLS?(noTLS="true",fakeHostName=`notls${fakeHostName}.net`,r=await 整理优选列表(addressesnotlsapi),a=await 整理测速结果("FALSE")):fakeHostName+=".xyz",console.log("虚假HOST: "+fakeHostName),`${subProtocol}://${c}/sub?host=${fakeHostName}&uuid=${fakeUserID+atob("JmVkZ2V0dW5uZWw9Y21saXUmcHJveHlpcD0=")+p}&path=`+encodeURIComponent(path)),n=!0;if(!c||""==c){if(i.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{var f=await fetch(proxyhostsURL);if(!f.ok)return void console.error("获取地址时出错:",f.status,f.statusText);var m=(await f.text()).split("\n").filter(e=>""!==e.trim());proxyhosts=proxyhosts.concat(m)}catch(e){console.error("获取地址时出错:",e)}proxyhosts=[...new Set(proxyhosts)]}s=await 整理优选列表(addressesapi),t=await 整理测速结果("TRUE"),o=`https://${i}/`+(fakeUserID+u.search),(i.includes("worker")||i.includes("notls")||"true"==noTLS)&&(u.search?o+="&notls":o+="?notls"),console.log("虚假订阅: "+o)}e.includes("CF-Workers-SUB".toLowerCase())||(e.includes("clash")&&!e.includes("nekobox")||u.searchParams.has("clash")&&!e.includes("subconverter")?(o=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(o)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,n=!1):(e.includes("sing-box")||e.includes("singbox")||(u.searchParams.has("singbox")||u.searchParams.has("sb"))&&!e.includes("subconverter"))&&(o=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(o)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,n=!1));try{let e;return e=c&&""!=c||1!=n?await(await fetch(o,{headers:{"User-Agent":d+atob("IENGLVdvcmtlcnMtZWRnZXR1bm5lbC9jbWxpdQ==")}})).text():await 生成本地订阅(fakeHostName,fakeUserID,noTLS,s,t,r,a),u.pathname=="/"+fakeUserID?e:恢复伪装信息(e,l,i,n)}catch(e){return console.error("Error fetching content:",e),"Error fetching content: "+e.message}}}async function 整理优选列表(e){if(!e||0===e.length)return[];let s="",t=new AbortController;var r,a,o,n=setTimeout(()=>{t.abort()},2e3);try{for([r,a]of(await Promise.allSettled(e.map(e=>fetch(e,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lZGdldHVubmVsL2NtbGl1")},signal:t.signal}).then(e=>e.ok?e.text():Promise.reject())))).entries())"fulfilled"===a.status&&(o=await a.value,e[r].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await 整理(o)).map(e=>{var s,e=e.split("#")[0]||e;return e.includes(":")?(s=e.split(":")[1],httpsPorts.includes(s)?null:e):e+":443"}).filter(Boolean))),s+=o+"\n")}catch(e){console.error(e)}finally{clearTimeout(n)}return await 整理(s)}async function 整理测速结果(t){if(!addressescsv||0===addressescsv.length)return[];var r,a=[];for(r of addressescsv)try{var e=await fetch(r);if(e.ok){var o=await e.text();let s;var n=(s=o.includes("\r\n")?o.split("\r\n"):o.split("\n"))[0].split(",").indexOf("TLS"),l=n+1;if(-1===n)console.error("CSV文件缺少必需的字段");else for(let e=1;e<s.length;e++){var i,c,d,p=s[e].split(","),u=p.length-1;p[n].toUpperCase()===t&&parseFloat(p[u])>DLS&&(i=p[0],c=p[1],d=p[l],a.push(i+`:${c}#`+d),r.includes("proxyip=true"))&&"true"==p[n].toUpperCase()&&!httpsPorts.includes(c)&&proxyIPPool.push(i+":"+c)}}else console.error("获取CSV地址时出错:",e.status,e.statusText)}catch(e){console.error("获取CSV地址时出错:",e);continue}return a}function 生成本地订阅(i,c,e,s,t,r,a){let d=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;addresses=(addresses=addresses.concat(s)).concat(t);let o;"true"==e&&(addressesnotls=(addressesnotls=addressesnotls.concat(r)).concat(a),s=[...new Set(addressesnotls)],o=s.map(e=>{let s="-1",t=e;var r=t.match(d);r?(e=r[1],s=r[2]||s,t=r[3]||e):(e.includes(":")&&e.includes("#")?(e=(r=e.split(":"))[0],r=r[1].split("#"),s=r[0],t=r[1]):e.includes(":")?(e=(r=e.split(":"))[0],s=r[1]):e.includes("#")&&(e=(r=e.split("#"))[0],t=r[1]),t.includes(":")&&(t=t.split(":")[0]));if(!isValidIPv4(e)&&"-1"==s)for(var a of["8080","8880","2052","2082","2086","2095"])if(e.includes(a)){s=a;break}"-1"==s&&(s="80");var r=i,o=path;return`${atob(啥啥啥_写的这是啥啊)}://${c}@${e}:${s+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT0mdHlwZT13cyZob3N0PQ==")+r}&path=${encodeURIComponent(o)}#`+encodeURIComponent(t+"")}).join("\n"));let n=[...new Set(addresses)].map(s=>{let e="-1",t=s;var r=t.match(d);if(r?(s=r[1],e=r[2]||e,t=r[3]||s):(s.includes(":")&&s.includes("#")?(s=(r=s.split(":"))[0],r=r[1].split("#"),e=r[0],t=r[1]):s.includes(":")?(s=(r=s.split(":"))[0],e=r[1]):s.includes("#")&&(s=(r=s.split("#"))[0],t=r[1]),t.includes(":")&&(t=t.split(":")[0])),!isValidIPv4(s)&&"-1"==e)for(var a of httpsPorts)if(s.includes(a)){e=a;break}"-1"==e&&(e="443");let o=i,n=path,l="";r=proxyIPPool.find(e=>e.includes(s)),r&&(n+="&proxyip="+r),0<proxyhosts.length&&o.includes(".workers.dev")&&(n="/"+o+n,o=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],l=" 已启用临时域名中转服务，请尽快绑定自定义域！"),r=atob(啥啥啥_写的这是啥啊);return`${r}://${c}@${s}:${e+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT10bHMmc25pPQ==")+o}&fp=random&type=ws&host=${o}&path=${encodeURIComponent(n)}#`+encodeURIComponent(t+l)}).join("\n");return"true"==e&&(n+=`
`+o),btoa(n)}async function 整理(e){e=e.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");return(e=","==(e=","==e.charAt(0)?e.slice(1):e).charAt(e.length-1)?e.slice(0,e.length-1):e).split(",")}async function sendMessage(s,t,r=""){if(BotToken&&ChatID)try{let e="";var a,o=await fetch(`http://ip-api.com/json/${t}?lang=zh-CN`),n=(e=o.ok?`${s}
IP: ${t}
国家: ${(a=await o.json()).country}
<tg-spoiler>城市: ${a.city}
组织: ${a.org}
ASN: ${a.as}
`+r:s+`
IP: ${t}
<tg-spoiler>`+r,`https://api.telegram.org/bot${BotToken}/sendMessage?chat_id=${ChatID}&parse_mode=HTML&text=`+encodeURIComponent(e));return fetch(n,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}catch(e){console.error("Error sending message:",e)}}function isValidIPv4(e){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}function 生成动态UUID(e){let s=new Date(2007,6,7,更新时间,0,0),t=864e5*有效时间;function r(e){e=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",e).then(e=>{e=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("");return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${(63&parseInt(e.substr(16,2),16)|128).toString(16)}${e.substr(18,2)}-`+e.substr(20,12)})}a=new Date,a=new Date(a.getTime()+288e5)-s;var a=Math.ceil(a/t),o=new Date(s.getTime()+a*t),n=r(e+a),e=r(e+(a-1)),a=`到期时间(UTC): ${new Date(o.getTime()-288e5).toISOString().slice(0,19).replace("T"," ")} (UTC+8): ${o.toISOString().slice(0,19).replace("T"," ")}
`;return Promise.all([n,e,a])}